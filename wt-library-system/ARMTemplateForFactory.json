{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "wt-library-system"
		},
		"DatalakeStorage_accountKey": {
			"type": "secureString",
			"metadata": "Secure string for 'accountKey' of 'DatalakeStorage'"
		},
		"src_db_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'src_db'"
		},
		"DatalakeStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://wtrecommenderstorage.dfs.core.windows.net/"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/pl_generate_book_keyword_join_table')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Join Keywords And Books",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "df_join_keywords_to_books",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"BookKeywordsFile": {},
									"BooksTable": {},
									"KeywordsTable": {},
									"keywordBookTable": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Import to db"
				},
				"annotations": [],
				"lastPublishTime": "2023-07-25T07:02:59Z"
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/df_join_keywords_to_books')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pl_import_books_and_keywords')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Import Keywords and Books",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "df_import_keywords_and_books",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"books": {},
									"keywords": {},
									"booksSink": {},
									"keywordSink": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Import to db"
				},
				"annotations": [],
				"lastPublishTime": "2023-07-25T07:02:59Z"
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/df_import_keywords_and_books')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Book_DIM')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "book_dim",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Book_Keyword_FACT')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "book_keyword_fact",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Keyword_DIM')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "keyword_dim",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Loan_FACT')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "loan_fact",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Review_FACT')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "review_fact",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/User_DIM')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Sink Data lake"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "user_dim",
						"fileSystem": "recommender"
					},
					"compressionCodec": "snappy"
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/books_import')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "import from files"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "books_import.csv",
						"fileSystem": "import"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": [
					{
						"name": "isbn",
						"type": "String"
					},
					{
						"name": "title",
						"type": "String"
					},
					{
						"name": "writer",
						"type": "String"
					},
					{
						"name": "publisher",
						"type": "String"
					},
					{
						"name": "avg_score",
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/books_keyword')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "books_keyword.csv",
						"fileSystem": "import"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": [
					{
						"name": "isbn",
						"type": "String"
					},
					{
						"name": "keyword",
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/keywordSink')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "books_keyword.csv",
						"fileSystem": "import"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/keywords_import')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DatalakeStorage",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "import from files"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "books_keywords.csv",
						"fileSystem": "import"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": [
					{
						"name": "isbn",
						"type": "String"
					},
					{
						"name": "keywords",
						"type": "String"
					}
				]
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/DatalakeStorage')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_book')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "active",
						"type": "bit"
					},
					{
						"name": "available",
						"type": "bit"
					},
					{
						"name": "isbn",
						"type": "nvarchar"
					},
					{
						"name": "photo",
						"type": "nvarchar"
					},
					{
						"name": "stock",
						"type": "int",
						"precision": 10
					},
					{
						"name": "title",
						"type": "nvarchar"
					},
					{
						"name": "writer",
						"type": "nvarchar"
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "book"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_copy')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "active",
						"type": "bit"
					},
					{
						"name": "book_id",
						"type": "bigint",
						"precision": 19
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "copy"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_employee')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "active",
						"type": "bit"
					},
					{
						"name": "admin",
						"type": "bit"
					},
					{
						"name": "email",
						"type": "nvarchar"
					},
					{
						"name": "first_name",
						"type": "nvarchar"
					},
					{
						"name": "last_name",
						"type": "nvarchar"
					},
					{
						"name": "password",
						"type": "nvarchar"
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "employee"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_keyword')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "keyword",
						"type": "nvarchar"
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "keyword"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_keyword_books')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "keywords_id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "books_id",
						"type": "bigint",
						"precision": 19
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "keyword_books"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_loan')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "loan_date",
						"type": "date"
					},
					{
						"name": "return_date",
						"type": "date"
					},
					{
						"name": "copy_id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "employee_id",
						"type": "bigint",
						"precision": 19
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "loan"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_reservation')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "allowed",
						"type": "bit"
					},
					{
						"name": "reservation_date",
						"type": "date"
					},
					{
						"name": "book_id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "employee_id",
						"type": "bigint",
						"precision": 19
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "reservation"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_table_review')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "src_db",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "Source db"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "rating",
						"type": "int",
						"precision": 10
					},
					{
						"name": "book_id",
						"type": "bigint",
						"precision": 19
					},
					{
						"name": "employee_id",
						"type": "bigint",
						"precision": 19
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "review"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/src_db')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/DatalakeStorage')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('DatalakeStorage_properties_typeProperties_url')]",
					"accountKey": {
						"type": "SecureString",
						"value": "[parameters('DatalakeStorage_accountKey')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/src_db')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"connectionString": "[parameters('src_db_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/df_etl_sql_to_datalake')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "src_table_book",
								"type": "DatasetReference"
							},
							"name": "BookTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_keyword",
								"type": "DatasetReference"
							},
							"name": "KeywordTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_employee",
								"type": "DatasetReference"
							},
							"name": "CustomerTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_keyword_books",
								"type": "DatasetReference"
							},
							"name": "BookKeywordsTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_copy",
								"type": "DatasetReference"
							},
							"name": "CopiesTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_loan",
								"type": "DatasetReference"
							},
							"name": "LoanTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_review",
								"type": "DatasetReference"
							},
							"name": "ReviewTable"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "Book_DIM",
								"type": "DatasetReference"
							},
							"name": "BookDIM"
						},
						{
							"dataset": {
								"referenceName": "Keyword_DIM",
								"type": "DatasetReference"
							},
							"name": "KeywordDIM"
						},
						{
							"dataset": {
								"referenceName": "User_DIM",
								"type": "DatasetReference"
							},
							"name": "UserDIM"
						},
						{
							"dataset": {
								"referenceName": "Book_Keyword_FACT",
								"type": "DatasetReference"
							},
							"name": "BookKeywordFACT"
						},
						{
							"dataset": {
								"referenceName": "Loan_FACT",
								"type": "DatasetReference"
							},
							"name": "LoanFACT"
						},
						{
							"dataset": {
								"referenceName": "Review_FACT",
								"type": "DatasetReference"
							},
							"name": "ReviewFACT"
						}
					],
					"transformations": [
						{
							"name": "trimBook"
						},
						{
							"name": "trimKeyword"
						},
						{
							"name": "trimUser"
						},
						{
							"name": "joinBooksAndCopies"
						},
						{
							"name": "JoinBookAndBooksKeywords"
						},
						{
							"name": "trimBooksAndKeywords"
						},
						{
							"name": "addCombinedColumnBookKeyword"
						},
						{
							"name": "aggregateCountToFilterDuplicates"
						},
						{
							"name": "dropDuplicatesBookKeywords"
						},
						{
							"name": "joinBooksAndLoans"
						},
						{
							"name": "trimLoans2"
						},
						{
							"name": "surrogateKeyBook"
						},
						{
							"name": "surrogateKeyLoan"
						},
						{
							"name": "joinLoansOnUserKey"
						},
						{
							"name": "surrogateKeyUser"
						},
						{
							"name": "surrogateKeyKeyword"
						},
						{
							"name": "JoinKeywordAndBooksKeywords"
						},
						{
							"name": "surrogateKeyReview"
						},
						{
							"name": "trimLoans"
						}
					],
					"scriptLines": [
						"source(output(",
						"          id as long,",
						"          active as boolean,",
						"          available as boolean,",
						"          isbn as string,",
						"          photo as string,",
						"          stock as integer,",
						"          title as string,",
						"          writer as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> BookTable",
						"source(output(",
						"          id as long,",
						"          keyword as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> KeywordTable",
						"source(output(",
						"          id as long,",
						"          active as boolean,",
						"          admin as boolean,",
						"          email as string,",
						"          first_name as string,",
						"          last_name as string,",
						"          password as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> CustomerTable",
						"source(output(",
						"          keywords_id as long,",
						"          books_id as long",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> BookKeywordsTable",
						"source(output(",
						"          id as long,",
						"          active as boolean,",
						"          book_id as long",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> CopiesTable",
						"source(output(",
						"          id as long,",
						"          loan_date as date,",
						"          return_date as date,",
						"          copy_id as long,",
						"          employee_id as long",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> LoanTable",
						"source(output(",
						"          id as long,",
						"          rating as integer,",
						"          book_id as long,",
						"          employee_id as long",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> ReviewTable",
						"surrogateKeyBook select(mapColumn(",
						"          book_key,",
						"          book_id = id",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimBook",
						"surrogateKeyKeyword select(mapColumn(",
						"          keyword_key,",
						"          keyword_id = id",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimKeyword",
						"surrogateKeyUser select(mapColumn(",
						"          user_key,",
						"          user_id = id",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimUser",
						"surrogateKeyBook, CopiesTable join(BookTable@id == book_id,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinBooksAndCopies",
						"surrogateKeyBook, BookKeywordsTable join(id == books_id,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> JoinBookAndBooksKeywords",
						"JoinKeywordAndBooksKeywords select(mapColumn(",
						"          book_key,",
						"          keyword_key",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimBooksAndKeywords",
						"trimBooksAndKeywords derive(book_keywords_id = concatWS('-', toString(book_key), toString(keyword_key))) ~> addCombinedColumnBookKeyword",
						"addCombinedColumnBookKeyword aggregate(groupBy(book_key,",
						"          keyword_key),",
						"     countCombined = count(book_keywords_id)) ~> aggregateCountToFilterDuplicates",
						"aggregateCountToFilterDuplicates select(mapColumn(",
						"          book_key,",
						"          keyword_key",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> dropDuplicatesBookKeywords",
						"joinBooksAndCopies, LoanTable join(CopiesTable@id == copy_id,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinBooksAndLoans",
						"joinLoansOnUserKey select(mapColumn(",
						"          loan_key,",
						"          loan_id = id,",
						"          loan_date,",
						"          return_date,",
						"          book_key,",
						"          user_key",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimLoans2",
						"BookTable keyGenerate(output(book_key as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKeyBook",
						"trimLoans keyGenerate(output(loan_key as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKeyLoan",
						"surrogateKeyLoan, trimUser join(employee_id == user_id,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinLoansOnUserKey",
						"CustomerTable keyGenerate(output(user_key as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKeyUser",
						"KeywordTable keyGenerate(output(keyword_key as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKeyKeyword",
						"JoinBookAndBooksKeywords, trimKeyword join(keywords_id == keyword_id,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> JoinKeywordAndBooksKeywords",
						"ReviewTable keyGenerate(output(review_key as long),",
						"     startAt: 1L,",
						"     stepValue: 1L) ~> surrogateKeyReview",
						"joinBooksAndLoans select(mapColumn(",
						"          id = LoanTable@id,",
						"          loan_date,",
						"          return_date,",
						"          book_key,",
						"          employee_id",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> trimLoans",
						"trimBook sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> BookDIM",
						"trimKeyword sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> KeywordDIM",
						"trimUser sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> UserDIM",
						"dropDuplicatesBookKeywords sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> BookKeywordFACT",
						"trimLoans2 sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> LoanFACT",
						"surrogateKeyReview sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'parquet',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> ReviewFACT"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/src_table_book')]",
				"[concat(variables('factoryId'), '/datasets/src_table_keyword')]",
				"[concat(variables('factoryId'), '/datasets/src_table_employee')]",
				"[concat(variables('factoryId'), '/datasets/src_table_keyword_books')]",
				"[concat(variables('factoryId'), '/datasets/src_table_copy')]",
				"[concat(variables('factoryId'), '/datasets/src_table_loan')]",
				"[concat(variables('factoryId'), '/datasets/src_table_review')]",
				"[concat(variables('factoryId'), '/datasets/Book_DIM')]",
				"[concat(variables('factoryId'), '/datasets/Keyword_DIM')]",
				"[concat(variables('factoryId'), '/datasets/User_DIM')]",
				"[concat(variables('factoryId'), '/datasets/Book_Keyword_FACT')]",
				"[concat(variables('factoryId'), '/datasets/Loan_FACT')]",
				"[concat(variables('factoryId'), '/datasets/Review_FACT')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/df_import_keywords_and_books')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"folder": {
					"name": "Import to db"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "books_import",
								"type": "DatasetReference"
							},
							"name": "books"
						},
						{
							"dataset": {
								"referenceName": "books_keyword",
								"type": "DatasetReference"
							},
							"name": "keywords"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "src_table_book",
								"type": "DatasetReference"
							},
							"name": "booksSink"
						},
						{
							"dataset": {
								"referenceName": "src_table_keyword",
								"type": "DatasetReference"
							},
							"name": "keywordSink"
						}
					],
					"transformations": [
						{
							"name": "addDetails"
						},
						{
							"name": "selectKeywordsOnly"
						},
						{
							"name": "aggregateToGroupDuplicates"
						},
						{
							"name": "filterOutCount"
						}
					],
					"scriptLines": [
						"source(output(",
						"          isbn as string,",
						"          title as string,",
						"          writer as string,",
						"          publisher as string,",
						"          avg_score as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false) ~> books",
						"source(output(",
						"          isbn as string,",
						"          keyword as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false) ~> keywords",
						"books derive(stock = 0,",
						"          active = 1 == 1,",
						"          available = 1 == 1,",
						"          photo = 'temp.jpg') ~> addDetails",
						"keywords select(mapColumn(",
						"          keyword",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectKeywordsOnly",
						"selectKeywordsOnly aggregate(groupBy(keyword),",
						"     count = count('1')) ~> aggregateToGroupDuplicates",
						"aggregateToGroupDuplicates select(mapColumn(",
						"          keyword",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> filterOutCount",
						"addDetails sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          id as long,",
						"          active as boolean,",
						"          available as boolean,",
						"          isbn as string,",
						"          photo as string,",
						"          stock as integer,",
						"          title as string,",
						"          writer as string",
						"     ),",
						"     deletable:false,",
						"     insertable:true,",
						"     updateable:false,",
						"     upsertable:false,",
						"     format: 'table',",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     errorHandlingOption: 'stopOnFirstError',",
						"     mapColumn(",
						"          active,",
						"          available,",
						"          isbn,",
						"          photo,",
						"          stock,",
						"          title,",
						"          writer",
						"     )) ~> booksSink",
						"filterOutCount sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          id as long,",
						"          keyword as string",
						"     ),",
						"     deletable:false,",
						"     insertable:true,",
						"     updateable:false,",
						"     upsertable:false,",
						"     format: 'table',",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     errorHandlingOption: 'stopOnFirstError') ~> keywordSink"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/books_import')]",
				"[concat(variables('factoryId'), '/datasets/books_keyword')]",
				"[concat(variables('factoryId'), '/datasets/src_table_book')]",
				"[concat(variables('factoryId'), '/datasets/src_table_keyword')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/df_join_keywords_to_books')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"folder": {
					"name": "Import to db"
				},
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "books_keyword",
								"type": "DatasetReference"
							},
							"name": "BookKeywordsFile"
						},
						{
							"dataset": {
								"referenceName": "src_table_book",
								"type": "DatasetReference"
							},
							"name": "BooksTable"
						},
						{
							"dataset": {
								"referenceName": "src_table_keyword",
								"type": "DatasetReference"
							},
							"name": "KeywordsTable"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "src_table_keyword_books",
								"type": "DatasetReference"
							},
							"name": "keywordBookTable"
						}
					],
					"transformations": [
						{
							"name": "joinIsbn"
						},
						{
							"name": "joinKeyword"
						},
						{
							"name": "SelectRelevantDataBook"
						},
						{
							"name": "selectRelevantDataKeyword"
						},
						{
							"name": "joinBooksAndKeywords"
						}
					],
					"scriptLines": [
						"source(output(",
						"          isbn as string,",
						"          keyword as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false) ~> BookKeywordsFile",
						"source(output(",
						"          id as long,",
						"          active as boolean,",
						"          available as boolean,",
						"          isbn as string,",
						"          photo as string,",
						"          stock as integer,",
						"          title as string,",
						"          writer as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> BooksTable",
						"source(output(",
						"          id as long,",
						"          keyword as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     isolationLevel: 'READ_UNCOMMITTED',",
						"     format: 'table') ~> KeywordsTable",
						"BooksTable, BookKeywordsFile join(BooksTable@isbn == BookKeywordsFile@isbn,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinIsbn",
						"KeywordsTable, BookKeywordsFile join(KeywordsTable@keyword == BookKeywordsFile@keyword,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinKeyword",
						"joinIsbn select(mapColumn(",
						"          book_id = id,",
						"          isbn = BooksTable@isbn,",
						"          keyword",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> SelectRelevantDataBook",
						"joinKeyword select(mapColumn(",
						"          keyword_id = id,",
						"          keyword = KeywordsTable@keyword,",
						"          isbn",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> selectRelevantDataKeyword",
						"SelectRelevantDataBook, selectRelevantDataKeyword join(SelectRelevantDataBook@isbn == selectRelevantDataKeyword@isbn",
						"     && SelectRelevantDataBook@keyword == selectRelevantDataKeyword@keyword,",
						"     joinType:'inner',",
						"     matchType:'exact',",
						"     ignoreSpaces: false,",
						"     broadcast: 'auto')~> joinBooksAndKeywords",
						"joinBooksAndKeywords sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     input(",
						"          keywords_id as long,",
						"          books_id as long",
						"     ),",
						"     deletable:false,",
						"     insertable:true,",
						"     updateable:false,",
						"     upsertable:false,",
						"     format: 'table',",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true,",
						"     errorHandlingOption: 'stopOnFirstError',",
						"     mapColumn(",
						"          keywords_id = keyword_id,",
						"          books_id = book_id",
						"     )) ~> keywordBookTable"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/books_keyword')]",
				"[concat(variables('factoryId'), '/datasets/src_table_book')]",
				"[concat(variables('factoryId'), '/datasets/src_table_keyword')]",
				"[concat(variables('factoryId'), '/datasets/src_table_keyword_books')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pl_etl_sql_to_datalake')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Transform SQL Data Into Recommender Datalake",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "df_etl_sql_to_datalake",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"BookTable": {},
									"KeywordTable": {},
									"CustomerTable": {},
									"BookKeywordsTable": {},
									"CopiesTable": {},
									"LoanTable": {},
									"ReviewTable": {},
									"BookDIM": {},
									"KeywordDIM": {},
									"UserDIM": {},
									"BookKeywordFACT": {},
									"LoanFACT": {},
									"ReviewFACT": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/df_etl_sql_to_datalake')]"
			]
		}
	]
}